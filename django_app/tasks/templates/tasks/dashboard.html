<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Workflow Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f8fafc;
            color: #1e293b;
            min-height: 100vh;
        }

        /* Navbar - Clean and Professional */
        .navbar {
            background: #ffffff !important;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            padding: 1rem 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.25rem;
            color: #0f172a !important;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .navbar-brand i {
            color: #3b82f6;
        }

        .navbar-text {
            color: #64748b;
            font-weight: 500;
        }

        .navbar-text strong {
            color: #0f172a;
        }

        .btn-logout {
            background: #f1f5f9;
            color: #3f4b5dff;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-logout:hover {
            background: #e2e8f0;
            color: #1e293b;
        }

        /* Container */
        .container {
            max-width: 1400px;
        }

        /* Stats Cards - Minimalist and Clean */
        .stats-section {
            margin: 1.5rem 0;
        }

        .stat-card {
            background: #ffffff;
            border-radius: 15px;
            padding: 1.25rem;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
            height: 100%;
        }

        .stat-card:hover {
            border-color: #cbd5e1;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transform: translateY(-2px);
        }

        .stat-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #0f172a;
            line-height: 1;
        }

        .stat-icon {
            width: 40px;
            height: 38px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .stat-card.primary .stat-icon {
            background: #eff6ff;
            color: #3b82f6;
        }

        .stat-card.warning .stat-icon {
            background: #fef3c7;
            color: #f59e0b;
        }

        .stat-card.danger .stat-icon {
            background: #fee2e2;
            color: #ef4444;
        }

        /* Main Cards */
        .main-card {
            background: #ffffff;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        .card-header-custom {
            background: #ffffff;
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-header-custom h5 {
            margin: 0;
            font-size: 1.125rem;
            font-weight: 700;
            color: #0f172a;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-header-custom h5 i {
            color: #3b82f6;
        }

        .card-body-custom {
            padding: 1.5rem;
        }

        /* Buttons - Professional Style */
        .btn-custom {
            padding: 0.625rem 1.25rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.2s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary-custom {
            background: #3b82f6;
            color: white;
        }

        .btn-primary-custom:hover {
            background: #74809cff;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(5, 15, 33, 0.3);
        }

        .btn-success-custom {
            background: #10b981;
            color: white;
        }

        .btn-success-custom:hover {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn-outline-custom {
            background: transparent;
            border: 1px solid #e2e8f0;
            color: #475569;
        }

        .btn-outline-custom:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
        }

        .btn-info-custom {
            background: #0ea5e9;
            color: white;
        }

        .btn-info-custom:hover {
            background: #0284c7;
        }

        /* Task Items */
        .section-title {
            font-size: 0.875rem;
            font-weight: 700;
            color: #475569;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 1rem;
        }

        .task-item {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 1.25rem;
            margin-bottom: 0.75rem;
            transition: all 0.2s;
        }

        .task-item:hover {
            background: #ffffff;
            border-color: #cbd5e1;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .task-title {
            font-size: 1rem;
            font-weight: 600;
            color: #0f172a;
            margin-bottom: 0.25rem;
        }

        .task-meta {
            font-size: 0.813rem;
            color: #64748b;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        /* Priority Badges */
        .badge-custom {
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .badge-high {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-medium {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-low {
            background: #dbeafe;
            color: #1e40af;
        }

        /* Action Buttons for Tasks */
        .btn-action {
            padding: 0.5rem 0.875rem;
            border-radius: 6px;
            font-size: 0.813rem;
            font-weight: 500;
            border: 1px solid #e2e8f0;
            background: white;
            color: #64748b;
            transition: all 0.2s;
        }

        .btn-action:hover {
            border-color: #cbd5e1;
            background: #f8fafc;
        }

        .btn-action.danger:hover {
            background: #fef2f2;
            border-color: #fecaca;
            color: #dc2626;
        }

        /* Suggested Tasks */
        .suggested-task {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 10px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }

        .suggested-task:hover {
            background: #e0f2fe;
            border-color: #7dd3fc;
        }

        .suggested-title {
            font-size: 0.938rem;
            font-weight: 600;
            color: #0c4a6e;
            margin-bottom: 0.5rem;
        }

        .suggested-desc {
            font-size: 0.813rem;
            color: #475569;
            margin-bottom: 1rem;
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
        }

        .empty-state i {
            font-size: 3rem;
            color: #cbd5e1;
            margin-bottom: 1rem;
        }

        .empty-state p {
            color: #64748b;
            font-size: 0.938rem;
        }

        /* Alerts */
        .alert-custom {
            border-radius: 10px;
            border: 1px solid;
            padding: 1rem 1.25rem;
            margin-bottom: 1rem;
        }

        .alert-success-custom {
            background: #f0fdf4;
            border-color: #bbf7d0;
            color: #166534;
        }

        .alert-warning-custom {
            background: #fffbeb;
            border-color: #fde68a;
            color: #92400e;
        }

        /* Floating Action Buttons */
        .floating-btn-group {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            z-index: 1000;
        }

        .fab {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            background: #3b82f6;
            color: white;
            font-size: 1.25rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.5);
        }

        .fab.speak {
            background: #10b981;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .fab.speak:hover {
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5);
        }

        /* Modal */
        .modal-backdrop-custom {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content-custom {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
        }

        .modal-header-custom {
            margin-bottom: 1.5rem;
        }

        .modal-header-custom h5 {
            font-size: 1.25rem;
            font-weight: 700;
            color: #0f172a;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: #475569;
            margin-bottom: 0.5rem;
        }

        .form-control {
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            padding: 0.75rem;
            font-size: 0.938rem;
            transition: all 0.2s;
        }

        .form-control:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .stat-value {
                font-size: 2rem;
            }
            
            .floating-btn-group {
                bottom: 1rem;
                right: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="{% url 'dashboard' %}">
                <i class="fas fa-robot"></i>
                AI Workflow Assistant
            </a>
            <div class="navbar-nav ms-auto d-flex align-items-center gap-3">
                <span class="navbar-text">
                    Welcome <strong>{{ user.username }}</strong>
                </span>
                <a class="btn-logout" href="{% url 'logout' %}">
                    <i class="fas fa-sign-out-alt me-1"></i>Logout
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Stats Section -->
        <div class="row stats-section">
            <div class="col-md-4 mb-2">
                <div class="stat-card primary">
                    <div class="stat-icon">
                        <i class="fas fa-tasks"></i>
                    </div>
                    <div class="stat-label">Total Tasks</div>
                    <div class="stat-value">{{ total_tasks }}</div>
                </div>
            </div>
            <div class="col-md-4 mb-2">
                <div class="stat-card warning">
                    <div class="stat-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-label">Pending</div>
                    <div class="stat-value">{{ pending_count }}</div>
                </div>
            </div>
            <div class="col-md-4 mb-2">
                <div class="stat-card danger">
                    <div class="stat-icon">
                        <i class="fas fa-exclamation-circle"></i>
                    </div>
                    <div class="stat-label">Overdue</div>
                    <div class="stat-value">{{ overdue_count }}</div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="row">
            <!-- Tasks Panel -->
            <div class="col-lg-8">
                <div class="main-card">
                    <div class="card-header-custom">
                        <h5>
                            <i class="fas fa-list-check"></i>
                            Your Tasks
                        </h5>
                        <div class="d-flex gap-2" style="transition: color 0.3s ease;" onmouseover="this.style.color='white'" onmouseout="this.style.color=''" >
                            <a href="{% url 'add_task' %}" class="btn-custom btn-primary-custom">
                                <i class="fas fa-plus"></i>
                                Add Task
                            </a>
                            <a id="gmail-connect-btn" href="#" onclick="tryGmailConnect({{ user.id }})" class="btn-custom btn-success-custom">
                                <i class="fas fa-envelope"></i>
                                Connect Gmail
                            </a>
                        </div>
                    </div>

                    <!-- Gmail Connection Alert -->
                    <div id="gmail-connect-error" style="display:none;">
                        <div class="alert-custom alert-warning-custom mx-3 mt-3">
                            <strong><i class="fas fa-info-circle me-2"></i>Having trouble connecting Gmail?</strong>
                            <div class="mt-2">
                                <button class="btn-custom btn-primary-custom btn-sm" onclick="showAccessModal()">
                                    <i class="fas fa-key"></i>
                                    Request Access
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="card-body-custom">
                        <div class="section-title">Pending Tasks</div>
                        
                        {% if pending_tasks %}
                            {% for task in pending_tasks %}
                            <div class="task-item">
                                <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                                    <div class="flex-grow-1">
                                        <div class="task-title">{{ task.title }}</div>
                                        <div class="task-meta">
                                            <i class="far fa-calendar"></i>
                                            Due: {{ task.due_date|date:"M d, Y H:i" }}
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="badge-custom {% if task.priority == 'high' %}badge-high{% elif task.priority == 'medium' %}badge-medium{% else %}badge-low{% endif %}">
                                            {{ task.get_priority_display }}
                                        </span>
                                        <a href="{% url 'edit_task' task.id %}" class="btn-action">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{% url 'delete_task' task.id %}" class="btn-action danger">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="empty-state">
                                <i class="fas fa-check-circle "></i>
                                <p>No pending tasks. Great job!</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Suggested Tasks Panel -->
            <div class="col-lg-4">
                <div class="main-card">
                    <div id="gmail-connected-alert" class="alert-custom alert-success-custom mx-3 mt-3" style="display:none;">
                        <i class="fas fa-check-circle me-2"></i>
                        Gmail successfully connected!
                    </div>

                    <div class="card-header-custom">
                        <h5>
                            <i class="fas fa-lightbulb"></i>
                            Suggested Tasks
                        </h5>
                        <button onclick="suggestTasks()" class="btn-custom btn-info-custom btn-sm">
                            <i class="fas fa-sync-alt"></i>
                            Sync
                        </button>
                    </div>

                    <div class="card-body-custom" id="suggested-tasks">
                        {% if suggested_tasks %}
                            {% for task in suggested_tasks %}
                            <div class="suggested-task">
                                <div class="suggested-title">{{ task.title }}</div>
                                <div class="suggested-desc">{{ task.description|truncatewords:18 }}</div>
                                <div class="d-flex gap-2">
                                    <button onclick="acceptTask({{ task.id }})" class="btn-custom btn-success-custom btn-sm flex-grow-1">
                                        <i class="fas fa-check"></i>
                                        Accept
                                    </button>
                                    <button onclick="ignoreTask({{ task.id }})" class="btn-action danger">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="empty-state">
                                <i class="fas fa-inbox"></i>
                                <p>First connect your gmail successfully , then you can sync emails.</p>
                                <p>Click "Sync" to get suggested tasks from your inbox.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Action Buttons -->
    <div class="floating-btn-group">
        <button class="fab speak" onclick="window.location.href='{% url 'speak_assistant' %}'">
            <i class="fas fa-microphone"></i>
        </button>
        <button class="fab" onclick="window.location.href='{% url 'chat_dashboard' %}'">
            <i class="fas fa-comments"></i>
        </button>
    </div>

    <!-- Access Request Modal -->
    <div id="request-access-modal" style="display:none;">
        <div class="modal-backdrop-custom" onclick="hideAccessModal()">
            <div class="modal-content-custom" onclick="event.stopPropagation()">
                <div class="modal-header-custom">
                    <h5>
                        <i class="fas fa-key"></i>
                        Request Gmail Access
                    </h5>
                </div>
                <form id="gmailAccessForm">
                    <div class="mb-3">
                        <label class="form-label">Email Address</label>
                        <input id="accessEmail" class="form-control" type="email" required placeholder="your.email@gmail.com">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Your Name (Optional)</label>
                        <input id="accessName" class="form-control" type="text" placeholder="John Doe">
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn-custom btn-success-custom flex-grow-1" type="submit">
                            <i class="fas fa-paper-plane"></i>
                            Send Request
                        </button>
                        <button type="button" class="btn-custom btn-outline-custom" onclick="hideAccessModal()">
                            Cancel
                        </button>
                    </div>
                    <div id="accessStatus" class="mt-3 text-center" style="color: #10b981; font-weight: 500;"></div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>
        window.showAccessModal = function() {
            document.getElementById('request-access-modal').style.display = 'block';
            document.getElementById('accessStatus').innerText = '';
        }
        
        window.hideAccessModal = function() {
            document.getElementById('request-access-modal').style.display = 'none';
        }

        emailjs.init('Ri5KWjNuRX1FghjUY');
        
        document.getElementById('gmailAccessForm').onsubmit = function(e) {
            e.preventDefault();
            emailjs.send('service_iqzqo4r', 'template_cubgn8p', {
                from_email: document.getElementById('accessEmail').value,
                from_name: document.getElementById('accessName').value
            })
            .then(function() {
                document.getElementById('accessStatus').innerText = "✓ Request sent! You'll be notified when approved.";
            }, function(error) {
                document.getElementById('accessStatus').innerText = "✗ Failed to send request!";
                console.error(error);
            });
        };

        window.showGmailRequestAccess = function() {
            document.getElementById('gmail-connect-error').style.display = 'block';
        };

        function acceptTask(taskId) {
            fetch(`http://localhost:9000/tasks/${taskId}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ suggested: false })
            })
            .then(() => location.reload());
        }

        function ignoreTask(taskId) {
            fetch(`http://localhost:9000/tasks/${taskId}`, { method: 'DELETE' })
            .then(() => location.reload());
        }

        function suggestTasks() {
            fetch('http://localhost:9000/gmail/suggest_tasks?user_id={{ user.id }}', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.suggested_tasks && data.suggested_tasks.length > 0) {
                    document.getElementById('suggested-tasks').innerHTML = data.suggested_tasks.map(task => `
                        <div class="suggested-task">
                            <div class="suggested-title">${task.title}</div>
                            <div class="suggested-desc">${task.description || ''}</div>
                            <div class="d-flex gap-2">
                                <button class="btn-custom btn-success-custom btn-sm flex-grow-1" onclick="acceptTask(${task.id})">
                                    <i class="fas fa-check"></i> Accept
                                </button>
                                <button class="btn-action danger" onclick="ignoreTask(${task.id})">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('suggested-tasks').innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><p>No new suggested tasks found.</p></div>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('suggested-tasks').innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle" style="color: #ef4444;"></i><p style="color: #ef4444;">Error syncing email. Check console.</p></div>';
            });
        }

        window.onload = function() {
            const params = new URLSearchParams(window.location.search);
            if (params.get('gmail_connected') === '1') {
                document.getElementById('gmail-connected-alert').style.display = 'block';
                window.history.replaceState({}, document.title, window.location.pathname);
            }
            showGmailRequestAccess();
        }

        function tryGmailConnect(userId) {
            window.open(`http://localhost:9000/gmail/start?user_id=${userId}`, "_blank");
            setTimeout(function() {
                showGmailRequestAccess();
            }, 3000);
        }
    </script>
</body>
</html>